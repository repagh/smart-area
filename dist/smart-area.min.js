angular.module("smartArea",[]).directive("smartArea",function(e){return{restrict:"A",scope:{areaConfig:"=smartArea",areaData:"=ngModel"},replace:!0,link:function(n,t){if("textarea"!==t[0].tagName.toLowerCase())return console.warn("smartArea can only be used on textareas"),!1;var o=["direction","overflowX","overflowY","paddingTop","paddingRight","paddingBottom","paddingLeft","letterSpacing","wordSpacing","whiteSpace","wordBreak","wordWrap"],r=angular.element('<div class="sa-wrapper"></div>');!(null===window.mozInnerScreenX);return n.fakeAreaElement=angular.element(e('<div class="sa-fakeArea" ng-trim="false" ng-bind-html="fakeArea"></div>')(n)).appendTo(r),"undefined"!=typeof n.areaConfig.cssclass&&n.areaConfig.cssclass.length>0&&n.areaConfig.cssclass.forEach(function(e){n.fakeAreaElement.addClass(e)}),n.dropdown.element=angular.element(e('<div class="sa-dropdown" ng-show="dropdown.content.length > 0"><input type="text" class="form-control" ng-show="dropdown.showFilter"/><ul class="dropdown-menu" role="menu" style="position:static"><li ng-repeat="element in dropdown.content" role="presentation"><a href="" role="menuitem" ng-click="dropdown.selected(element)" ng-class="{active: $index == dropdown.current}" ng-bind-html="element.display"></a></li></ul></div>')(n)).appendTo(r),n.dropdown.filterElement=n.dropdown.element.find("input"),n.dropdown.filterElement.bind("keydown",n.keyboardEvents),n.fakeAreaElement.css("whiteSpace","pre-wrap"),n.fakeAreaElement.css("wordWrap","break-word"),o.forEach(function(e){n.fakeAreaElement.css(e,t.css(e))}),r.insertBefore(t),t.appendTo(r).addClass("sa-realArea").attr("ng-trim",!1),e(t),t.on("keyup",function(){n.fakeAreaElement.height(t.height()),n.fakeAreaElement.width(t.width())}),r},controller:["$scope","$element","$timeout","$sce",function(e,n,t,o){function r(o,r){e.dropdown.showFilter=!1;var a=e.areaData,s=c(),l=a.substr(0,s).split(/[\s\b{}]/),i=l[l.length-1].length;!r&&e.dropdown.match&&(i=e.dropdown.match.length),(r||0>i)&&(i=0),e.areaData=a.substr(0,s-i)+o+a.substr(s),!r&&e.dropdown.match&&(s=s-e.dropdown.match.length+o.toString().length),n[0].selectionStart&&t(function(){n[0].focus(),n[0].setSelectionRange(s-i+o.toString().length,s-i+o.toString().length),d()},100)}function a(){var n=e.areaData;"undefined"!=typeof e.areaConfig.autocomplete&&0!==e.areaConfig.autocomplete.length&&(e.areaConfig.autocomplete.forEach(function(e){for(var t=0;t<e.words.length;t++)n="string"==typeof e.words[t]?n.replace(new RegExp("([^\\w]|\\b)("+e.words[t]+")([^\\w]|\\b)","g"),'$1<span class="'+e.cssClass+'">$2</span>$3'):n.replace(e.words[t],function(n){return'<span class="'+e.cssClass+'">'+n+"</span>"})}),e.fakeArea=o.trustAsHtml(n))}function d(){i(),s()}function s(){e.dropdown.showFilter=!1,e.dropdown.match=!1,"undefined"!=typeof e.areaConfig.dropdown&&0!==e.areaConfig.dropdown.length&&e.areaConfig.dropdown.forEach(function(n){var r=e.areaData,a=c();if("string"==typeof n.trigger&&n.trigger===r.substr(a-n.trigger.length,n.trigger.length))n.list(function(r){e.dropdown.content=r.map(function(e){return e.display=o.trustAsHtml(e.display),e}),e.dropdown.customSelect=n.onSelect,e.dropdown.mode=n.mode||"append",e.dropdown.match="",e.dropdown.showFilter=n.filter||!1,t(function(){e.dropdown.filterElement.focus()},10)});else if("object"==typeof n.trigger){for(var d,s=r.substr(0,a),l=!1,i=-1;null!==(d=n.trigger.exec(s))&&d.index!==i;)if(i=d.index,d.index+d[0].length===a){l=!0;break}l&&n.list(d,function(t){e.dropdown.content=t.map(function(e){return e.display=o.trustAsHtml(e.display),e}),e.dropdown.customSelect=n.onSelect,e.dropdown.mode=n.mode||"append",e.dropdown.match=d[1],e.dropdown.showFilter=n.filter||!1})}})}function l(){t(function(){e.fakeAreaElement.scrollTop(n.scrollTop())},5)}function i(){var n=[],t=[],r=e.areaData,a=c(),d=r.substr(0,a).split(/[\s\b{}]/);d=d[d.length-1],e.areaConfig.autocomplete.forEach(function(e){e.words.forEach(function(t){"string"==typeof t&&n.indexOf(t)<0&&(d.length>0||d.length<1&&e.autocompleteOnSpace)&&n.push(t)})}),void 0!==e.areaConfig.dropdown&&e.areaConfig.dropdown.forEach(function(e){"string"==typeof e.trigger&&n.indexOf(e.trigger)<0&&n.push(e.trigger)}),n.forEach(function(e){d.length<e.length&&e.toLowerCase().substr(0,d.length)===d.toLowerCase()&&t.push({display:o.trustAsHtml(e),data:null})}),e.dropdown.customSelect=null,e.dropdown.current=0,e.dropdown.content=t}function c(){var e=n[0];return"number"==typeof e.selectionEnd?e.selectionEnd:void 0}e.fakeArea=e.areaData,e.dropdownContent="Dropdown",e.dropdown={content:[],element:null,current:0,select:null,customSelect:null,filter:"",match:"",mode:"append",showFilter:!1,filterElement:null},e.$watch("areaData",function(){e.trackCaret(),d()}),e.trackCaret=function(){var r=e.areaData,d=c();e.fakeArea=o.trustAsHtml(r.substring(0,d)+'<span class="sa-tracking"></span>'+r.substring(d)),t(function(){var t=e.fakeAreaElement.find("span.sa-tracking");if(t.length>0){var o=t.position();e.dropdown.element.css({top:o.top+parseInt(n.css("fontSize"))+2+"px",left:o.left+"px"})}a()},0)},e.keyboardEvents=function(o){if(e.dropdown.content.length>0){var r=o.keyCode||o.which;13===r?(o.preventDefault(),o.stopPropagation(),t(function(){e.dropdown.selected(e.dropdown.content[e.dropdown.current])},0)):38===r?(o.preventDefault(),o.stopPropagation(),t(function(){e.dropdown.current--,e.dropdown.current<0&&(e.dropdown.current=e.dropdown.content.length-1)},0)):40===r?(o.preventDefault(),o.stopPropagation(),t(function(){e.dropdown.current++,e.dropdown.current>=e.dropdown.content.length&&(e.dropdown.current=0)},0)):27===r?(o.preventDefault(),o.stopPropagation(),t(function(){e.dropdown.content=[],n[0].focus()},0)):e.dropdown.filterElement.focus()}},e.dropdown.selected=function(n){if(null!==e.dropdown.customSelect){var t="append"===e.dropdown.mode;r(e.dropdown.customSelect(n),t)}else r(n.display);e.dropdown.content=[]},n.bind("keyup click focus",function(){t(function(){e.trackCaret()},0)}),n.bind("keydown",function(n){l(),e.keyboardEvents(n)})}]}});